<!DOCTYPE html>
<meta charset="utf8"/>
<script src=../js/essential.js></script>
<script src=../js/sha256.js></script>
<script src=../js/ipfs.js></script>
<script src=../js/functions.js></script>

<div>
peerid: <span id=peerid></span>
<br>network: <button id=join onclick="join(event)">join wlog</button>
<br>token: <span id=token></span>
<br>local: <span id=local></span>
<br>find: <button id=provs onclick="provs(event)">provs</button> <span id=status></span>
<div id=peerids></div>

<br>line: <input type=text name=record size=74>
<br><button id=append onclick="append(event)">append</button>
<button id=publish onclick="publish(event)">publish</button>
<button id=update onclick="update(event)">update</button>
<button id=reduce onclick="reduce(event)">reduce</button>
<br>url: <span id=url></span>
<br>root: <span id=root></span>
<br>remote: <span id=remote></span>
<br>wlog:<br><textarea id=file cols=80 rows=25></textarea>
</div>


<script>
var peerid;
const key='clef-secrete';
const label='a-big-log.txt';
const uri=`${key},urn:wwlog:${label}`;
let nid= getNid(uri);
let logf = `/public/share/${nid}/${label}`;
var token;
var peerids;

main();
async function main() {
   await Promise.resolve(promisedConfig); // just to wait for config !
   peerid = await Promise.resolve(promisedPeerId);
   document.getElementById('peerid').innerHTML = `<a href=${gw_url}/ipns/${peerid}>${peerid}</a>`;
   document.getElementById('local').innerHTML = `<a href=${gw_url}/ipns/${peerid}${logf}>${logf}</a>`;
   console.log('main.peerid:',peerid);
   token = await get_token(nid);
   display_status('pending');
   peerids = await ipfsFindProvs(token);
   display_status('ok');
   console.log('main.peerids',peerids);
}

async function get_token(str) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  token = await ipfsGetToken(str);
  console.debug(callee+'.token:',token);
  document.getElementById('token').innerHTML = token;
  return token
}


async function join(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  let token = await ipfsAddToken(nid);
  console.debug(callee+'.token:',token);
  document.getElementById('token').innerHTML = `<a href=${gw_url}/ipfs/${token}>${token}</a>`;
  display_file(logf);
}

async function display_file(file) {
  let content = await getMFSFileContent(file);
  document.getElementById('file').value = content;
}

async function provs(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  if (typeof(peerids) == 'undefined') {
    console.debug(callee+'.token:',token);
    display_status('pending');
    peerids = await ipfsFindProvs(token);
    display_status('ok');
  }
  let buf = '<ul>';
  for (peer of peerids) {
    buf += `<li><a target=_blank href=${gw_url}/ipns/${peer}/>${peer}</a></li>\n`
  }
  buf += "</ul>\n";
  document.getElementById('peerids').innerHTML = buf;
  
}


async function reduce(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  let seen = {};
  let result = '';
  let content = await getMFSFileContent(logf);
  let lines = content.split(/\n/);
  console.debug(callee+'.lines:',lines);
  for (let line of lines) {
    if (typeof(seen[line]) == 'undefined') {
      result += line+ "\n";
      seen[line]++;
    }
  }
  console.debug(callee+'.result:',[{result}]);
  await mfsRemove(logf);
  await mfsCopy('QmbFMke1KXqnYyBBWxB74N4c5SBnJMVAiMNRcGu6x1AwQH',logf);
  let qmlogf = await ipfsLogAppend(logf,result);
  document.getElementById('url').innerHTML = `<a href="${gw_url}/ipfs/${qmlogf}">/ipfs/${qmlogf}</a>`
  display_file(logf);
  return qmlogf
}

async function update(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  document.getElementById('update').disabled=true
  let qmlogf;
  let buf = '<ul>';
  for (let peer of peerids) {
    console.log(callee+'.peer:',peer);
    if (peer == peerid) { continue }
    let ipath = await ipfsNameResolve(peer);
    if (typeof(ipath) != 'undefined') {
    console.log(callee+'.ipath:',ipath);
    let qpath = await ipfsResolve(`${ipath}${logf}`);
    if (typeof(qpath) != 'undefined') {
       console.debug(callee+'.qpath:',qpath);
       let log = await ipfsGetContentByHash(qpath);
       console.debug(callee+'.log:',log);
       qmlogf = await ipfsLogAppend(logf,log);
       console.debug(callee+'.qmlogf:',qmlogf);
       buf += `<li><a target=_blank href=${gw_url}${qpath}/>${ipath}${logf}</a></li>\n`;
       document.getElementById('remote').innerHTML = buf + "</ul>";
       display_file(logf);
    }
    }
  }
  buf += "</ul>\n";
  document.getElementById('update').disabled=false;
  document.getElementById('remote').innerHTML = buf;
  console.debug(callee+'.qmlogf:',qmlogf);
  return qmlogf;
}

async function publish(ev) {
 document.getElementById('publish').disabled=true
 let qm = await publish_root();
 document.getElementById('root').innerHTML = `<a href="${gw_url}/ipfs/${qm}">${qm}</a>`
 document.getElementById('publish').disabled=false
 
}

async function append(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  let line = document.getElementsByName('record')[0].value;
  console.debug(callee+'.line:',line);
  //let buf = await getMFSFileContent(path);
  let date = getDate();
  let time = getTime();
  let header = `# user:${peerid} on ${date} @ ${time}\n`;
  let hash = await ipfsLogAppend(logf,header+line+"\n");
  console.log(callee+'.hash:',hash);
  document.getElementById('url').innerHTML = `<a href=${gw_url}/ipfs/${hash}>${logf}</a>`;
  display_file(logf);
}

function display_status(s) {
  let imgs = { 'pending':'img/spinner.png', 'ok':'img/check-mark.png' };
  document.getElementById('status').innerHTML=`<img alt=${s} src=${imgs[s]} height="24">`;
  if (s.match('pending')) {
     document.getElementById('update').disabled=true
  } else if (s.match('ok')) { 
     document.getElementById('update').disabled=false
  }
}
</script>

