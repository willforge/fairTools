<!DOCTYPE html>
<meta charset="utf8"/>
<script src=../js/essential.js></script>
<script src=../js/sha256.js></script>
<script src=../js/ipfs.js></script>
<script src=../js/functions.js></script>

<div>
network: <button id=join onclick="join(event)">join wlog</button>
<br>token: <span id=token></span>
<br>find: <button id=provs onclick="provs(event)">provs</button> <span id=status></span>
<div id=peerids></div>

<br>line: <input type=text name=record size=74>
<br><button id=append onclick="append(event)">append</button>
<button id=publish onclick="publish(event)">publish</button>
<button id=update onclick="update(event)">update</button>
<br>url: <span id=url><span>
<br>root: <span id=root><span>
</div>


<script>
var peerid;
const key='clef-secrete';
const label='a-big-log.txt';
const uri=`${key},urn:wwlog:${label}`;
let nid= getNid(uri);
var token;
var peerids;

main();
async function main() {
   await Promise.resolve(promisedConfig); // just to wait for config !
   peerid = await Promise.resolve(promisedPeerId);
   console.info('main.peerid:',peerid);
   token = await get_token(nid);
   display_status('pending');
   peerids = await ipfsFindProvs(token);
   display_status('ok');
   console.log('main.peerids',peerids);
}

async function get_token(str) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  token = await ipfsGetToken(str);
  console.debug(callee+'.token:',token);
  document.getElementById('token').innerHTML = token;
  return token
}


async function join(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  let token = await ipfsAddToken(nid);
  console.debug(callee+'.token:',token);
  document.getElementById('token').innerHTML = `<a href=http://127.0.0.1:8080/ipfs/${token}>${token}</a>`;
}

async function provs(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  if (typeof(peerids) == 'undefined') {
    console.debug(callee+'.token:',token);
    display_status('pending');
    peerids = await ipfsFindProvs(token);
    display_status('ok');
  }
  let buf = '<ul>';
  for (peer of peerids) {
    buf += `<li><a target=_blank href=http://127.0.0.1:8080/ipns/${peer}/>${peer}</a></li>\n`
  }
  buf += "</ul>\n";
  document.getElementById('peerids').innerHTML = buf;
  
}

async function update(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  for (let peer of peerids) {
    console.log(callee+'.peer:',peer);
    if (peer == peerid) { continue }
  } 
}

async function publish(ev) {
 let qm = await publish_root();
 document.getElementById('root').innerHTML = `<a href="${gw_url}/ipfs/${qm}">${qm}</a>`
 
}

async function append(ev) {
  let [callee, caller] = functionNameJS(); // logInfo("message !")
  let line = document.getElementsByName('record')[0].value;
  console.debug(callee+'.line:',line);
  let file = `/public/share/${nid}/${label}`
  //let buf = await getMFSFileContent(path);
  let date = getDate();
  let time = getTime();
  let header = `# user:${peerid} on ${date} @ ${time}\n`;
  let hash = await ipfsLogAppend(file,header+line+"\n");
  console.log(callee+'.hash:',hash);
  document.getElementById('url').innerHTML = `<a href=${gw_url}/ipfs/${hash}>${file}</a>`;
}

function display_status(s) {
  let imgs = { 'pending':'img/spinner.png', 'ok':'img/check-mark.png' };
  document.getElementById('status').innerHTML=`<img alt=${s} src=${imgs[s]} height="24">`;
}
</script>

